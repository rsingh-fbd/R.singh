<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini IPTV + EPG</title>

<style>
body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial;
}
#player {
    width: 100%;
    height: 55vh;
    background: #000;
}
#epgBox {
    padding: 10px;
    background: #111;
    font-size: 14px;
}
#channelList {
    height: 40vh;
    overflow-y: auto;
}
.ch {
    padding: 8px;
    border-bottom: 1px solid #333;
    cursor: pointer;
}
.ch:hover, .active {
    background: #444;
}
</style>
</head>

<body>

<video id="player" controls autoplay playsinline></video>

<div id="epgBox">Loading EPG…</div>
<div id="channelList"></div>

<script>
/* ================= CONFIG ================= */
const M3U_URL = "https://raw.githubusercontent.com/rsingh-fbd/R.singh/main/playlist1.m3u";
const EPG_URL = "https://iptv-org.github.io/epg/guides/in/jiotv.com.epg.xml";

/* ======================================== */
let channels = [];
let epgData = {};

/* -------- LOAD M3U -------- */
async function loadM3U() {
    const txt = await fetch(M3U_URL).then(r => r.text());
    const lines = txt.split("\n");

    let current = {};

    for (let line of lines) {
        line = line.trim();

        if (line.startsWith("#EXTINF")) {
            current = {};
            current.id =
                (line.match(/tvg-id="(.*?)"/) || [,""])[1].toLowerCase();
            current.name =
                (line.split(",")[1] || "Unknown").trim();
        }
        else if (line.startsWith("http")) {
            current.url = line;
            channels.push(current);
        }
    }

    renderChannels();
}

/* -------- RENDER LIST -------- */
function renderChannels() {
    const box = document.getElementById("channelList");
    box.innerHTML = "";

    channels.forEach((ch, i) => {
        const div = document.createElement("div");
        div.className = "ch";
        div.textContent = ch.name;
        div.onclick = () => playChannel(i);
        box.appendChild(div);
    });
}

/* -------- PLAY -------- */
function playChannel(i) {
    const player = document.getElementById("player");
    player.src = channels[i].url;
    player.load();
    player.play();

    document.querySelectorAll(".ch").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".ch")[i].classList.add("active");

    showEPG(channels[i]);
}

/* -------- LOAD EPG -------- */
async function loadEPG() {
    try {
        const xmlText = await fetch(EPG_URL).then(r => r.text());
        const doc = new DOMParser().parseFromString(xmlText, "text/xml");

        doc.querySelectorAll("programme").forEach(p => {
            const id = p.getAttribute("channel").toLowerCase();
            if (!epgData[id]) epgData[id] = [];

            epgData[id].push({
                start: p.getAttribute("start"),
                stop:  p.getAttribute("stop"),
                title: p.querySelector("title")?.textContent || ""
            });
        });

        document.getElementById("epgBox").innerHTML = "EPG loaded ✔";
    }
    catch (e) {
        document.getElementById("epgBox").innerHTML = "EPG load failed ❌";
    }
}

/* -------- SHOW EPG -------- */
function showEPG(ch) {
    const box = document.getElementById("epgBox");
    const now = epgTimeUTC();

    let list =
        epgData[ch.id] ||
        epgData[ch.name.toLowerCase()] ||
        null;

    if (!list) {
        box.innerHTML = "No EPG available";
        return;
    }

    const cur = list.find(p => p.start <= now && p.stop >= now);

    if (!cur) {
        box.innerHTML = "No current program";
        return;
    }

    box.innerHTML = `<b>${cur.title}</b><br>
        ${cur.start.slice(8,12)} - ${cur.stop.slice(8,12)}`;
}

/* -------- TIME -------- */
function epgTimeUTC() {
    const d = new Date();
    return d.getUTCFullYear() +
        pad(d.getUTCMonth()+1) +
        pad(d.getUTCDate()) +
        pad(d.getUTCHours()) +
        pad(d.getUTCMinutes()) +
        pad(d.getUTCSeconds()) +
        " +0000";
}
function pad(n){ return n < 10 ? "0"+n : n; }

/* -------- INIT -------- */
loadEPG();
loadM3U();
</script>

</body>
</html>