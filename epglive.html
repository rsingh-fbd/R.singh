<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini IPTV + EPG</title>
<style>
    body { margin:0; background:#000; color:#fff; font-family:Arial; }
    #player { width:100%; height:55vh; background:#000; }
    #channelList { height:45vh; overflow-y:auto; padding:10px; }
    .ch { padding:8px; border-bottom:1px solid #333; cursor:pointer; }
    .ch:hover, .active { background:#444; }
    #epgBox { padding:10px; font-size:14px; background:#111; }
</style>
</head>
<body>

<video id="player" controls autoplay></video>

<div id="epgBox">Loading EPG...</div>

<div id="channelList"></div>

<script>

// -----------------------------
//  CONFIG
// -----------------------------
// const M3U_URL = "https://iptv-org.github.io/iptv/categories/news.m3u";
const EPG_URL = "https://avkb.short.gy/epg.xml.gz";   // Your EPG

let channels = [];
let epgData = {};  // { tvg-id : [ {start, stop, title} ] }

// -----------------------------
//  LOAD M3U CHANNELS
// -----------------------------
async function loadM3U() {
    let txt = await fetch(M3U_URL).then(r => r.text());
    let lines = txt.split("\n");

    let temp = {};
    lines.forEach(l => {
        if (l.startsWith("#EXTINF")) {
            let id = (l.match(/tvg-id="(.*?)"/) || [,""])[1];
            let name = l.split(",")[1] || "Unknown";
            temp = { id, name };
        } else if (l.startsWith("http")) {
            temp.url = l.trim();
            channels.push(temp);
        }
    });

    renderChannels();
}

// -----------------------------
//  RENDER CHANNEL LIST
// -----------------------------
function renderChannels() {
    let div = document.getElementById("channelList");
    div.innerHTML = "";

    channels.forEach((ch, i) => {
        let el = document.createElement("div");
        el.className = "ch";
        el.textContent = ch.name;
        el.onclick = () => playChannel(i);
        div.appendChild(el);
    });
}

// -----------------------------
//  PLAY CHANNEL
// -----------------------------
function playChannel(i) {
    let p = document.getElementById("player");
    p.src = channels[i].url;

    [...document.querySelectorAll(".ch")].forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".ch")[i].classList.add("active");

    showEPG(channels[i].id);
}

// -----------------------------
//  LOAD + PARSE EPG
// -----------------------------
async function loadEPG() {
    try {
        let arr = new Uint8Array(await fetch(EPG_URL).then(r=>r.arrayBuffer()));
        let decompressed = ungzip(arr); // gunzip (function below)
        let xml = new TextDecoder("utf-8").decode(decompressed);

        let parser = new DOMParser();
        let doc = parser.parseFromString(xml, "text/xml");

        doc.querySelectorAll("programme").forEach(p => {
            let id = p.getAttribute("channel");
            if (!epgData[id]) epgData[id] = [];

            epgData[id].push({
                start: p.getAttribute("start"),
                stop:  p.getAttribute("stop"),
                title: p.querySelector("title") ? p.querySelector("title").textContent : ""
            });
        });

        document.getElementById("epgBox").innerHTML = "EPG Loaded";
    } 
    catch(e){
        document.getElementById("epgBox").innerHTML = "EPG load error";
    }
}

// -----------------------------
//  SHOW CURRENT EPG
// -----------------------------
function showEPG(id) {
    let box = document.getElementById("epgBox");
    if (!epgData[id]) {
        box.innerHTML = "No EPG found";
        return;
    }

    let now = new Date();
    let nowStr = dateToEPG(now);

    // find current program
    let prog = epgData[id].find(p => p.start <= nowStr && p.stop >= nowStr);

    if (!prog) {
        box.innerHTML = "No EPG for now";
        return;
    }

    box.innerHTML = `<b>${prog.title}</b><br>${prog.start} - ${prog.stop}`;
}

// Convert JS Date â†’ "YYYYMMDDHHMMSS +0000"
function dateToEPG(d) {
    return d.getFullYear() +
        pad(d.getMonth()+1) +
        pad(d.getDate()) +
        pad(d.getHours()) +
        pad(d.getMinutes()) +
        pad(d.getSeconds()) +
        " +0000";
}

function pad(n){ return n<10?"0"+n:n; }

// -----------------------------
//  GZIP DECOMPRESS (tiny script)
// -----------------------------
function ungzip(data){
    return window.pako.inflate(data);
}

// Load pako (gzip library)
let script = document.createElement("script");
script.src = "https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js";
script.onload = () => {
    loadEPG();
    loadM3U();
};
document.body.appendChild(script);

</script>
</body>
</html>