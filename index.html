<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart TV Live Player</title>
  <style>
    :root {
      --panel: rgba(20,20,20,.95);
      --btn: rgba(0,0,0,.6);
      --btn-hover: rgba(0,0,0,.8);
      --hl: #0a6cff;
    }
    body {
      margin:0; background:#000; color:#fff;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    #player { width:100vw; height:100vh; position:relative; background:#000; }
    video { width:100%; height:100%; object-fit:contain; background:#000; }

    /* Controls */
    #controls {
      position:absolute; left:50%; bottom:28px; transform:translateX(-50%);
      display:flex; align-items:center; gap:10px;
      opacity:0; transition:opacity .25s; z-index:900; user-select:none;
    }
    #controls.show { opacity:1; }
    .btn {
      background:var(--btn); border:none; color:#fff; padding:10px 12px;
      border-radius:8px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px;
    }
    .btn:focus-visible { outline:2px solid #fff; outline-offset:2px; }
    .btn:hover { background:var(--btn-hover); }
    #volume { -webkit-appearance:none; width:110px; height:6px; border-radius:4px; background:#444; }
    #volume::-webkit-slider-thumb {
      -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; cursor:pointer;
    }

    /* Channel overlay */
    #channelOverlay {
      position:fixed; inset:auto auto 0 0; top:0; width:300px; max-width:85vw;
      background:var(--panel); transform:translateX(-100%); transition:transform .28s ease;
      z-index:1000; display:flex; flex-direction:column;
    }
    #channelOverlay.show { transform:translateX(0); }
    #channelHeader { padding:12px 14px; font-weight:600; border-bottom:1px solid #333; }
    #channelList { list-style:none; margin:0; padding:0; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    #channelList li {
      display:flex; align-items:center; gap:10px; padding:12px 14px;
      border-bottom:1px solid #333; cursor:pointer; transition:background .15s;
    }
    #channelList li img { width:36px; height:36px; object-fit:contain; }
    #channelList li span { flex:1; }
    #channelList li.active { background:#1f2633; }
    #channelList li.highlight { background:var(--hl); color:#fff; }

    /* Toast */
    #toast {
      position:fixed; left:20px; bottom:20px; display:flex; align-items:center; gap:10px;
      background:rgba(0,0,0,.8); padding:10px 14px; border-radius:8px; opacity:0; transition:opacity .4s;
      z-index:1100;
    }
    #toast.show { opacity:1; }
    #toast img { width:28px; height:28px; object-fit:contain; }

    /* Buffering + Error */
    #buffering, #error {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:950; text-align:center;
    }
    #buffering { color:#fff; font-size:18px; display:none; }
    #buffering.show { display:block; }
    #error { background:rgba(255,0,0,.85); padding:18px 20px; border-radius:8px; display:none; max-width:80vw; }
    #error.show { display:block; }

    /* Quality menu */
    #qualityMenu {
      position:absolute; bottom:72px; right:0;
      background:var(--panel); border:1px solid #333; border-radius:10px;
      min-width:160px; padding:6px; display:none; z-index:1001;
      box-shadow:0 8px 24px rgba(0,0,0,.45);
    }
    #qualityMenu.show { display:block; }
    .q-item {
      padding:10px 12px; cursor:pointer; border-radius:6px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .q-item:hover, .q-item.active { background:#263042; }
    .q-hint { font-size:12px; opacity:.8; margin-left:8px; }

    .anchor { position:relative; display:inline-flex; }

    @media (max-width:720px){
      #controls { gap:8px; }
      #volume { width:86px; }
      #channelOverlay { width:86vw; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
</head>
<body>
  <div id="player">
    <video id="video" autoplay playsinline></video>

    <div id="controls" role="region" aria-label="Player controls">
      <button class="btn" id="prevBtn" aria-label="Previous Channel">‚èÆ Prev</button>
      <button class="btn" id="nextBtn" aria-label="Next Channel">Next ‚è≠</button>
      <input type="range" id="volume" min="0" max="1" step="0.05" value="1" aria-label="Volume control">
      <button class="btn" id="channelBtn" aria-label="Open Channels">üì∫ Channels</button>
      <span class="anchor">
        <button class="btn" id="qualityBtn" aria-haspopup="true" aria-expanded="false" aria-controls="qualityMenu">‚öôÔ∏è Quality</button>
        <div id="qualityMenu" role="menu" aria-label="Quality options"></div>
      </span>
      <button class="btn" id="fsBtn" aria-label="Fullscreen">‚õ∂ Fullscreen</button>
    </div>

    <div id="buffering">Buffering‚Ä¶</div>
    <div id="error" role="alert"></div>
  </div>

  <aside id="channelOverlay" role="menu" aria-label="Channel list">
    <div id="channelHeader">Channels</div>
    <ul id="channelList"></ul>
  </aside>

  <div id="toast" role="status" aria-live="polite">
    <img id="toastLogo" alt="Channel logo" loading="lazy">
    <span id="toastText"></span>
  </div>

  <script>
    (() => {
      "use strict";

      // === Config ===
      const CONFIG = {
        m3uUrl: "https://raw.githubusercontent.com/rsingh-fbd/R.singh/main/Playlist.m3u",
        toastDuration: 3000,
        controlsHideDelay: 3000,
        debounceDelay: 200
      };

      // === DOM ===
      const $ = id => document.getElementById(id);
      const DOM = {
        player: $("player"), video: $("video"), controls: $("controls"),
        prevBtn: $("prevBtn"), nextBtn: $("nextBtn"), volume: $("volume"),
        channelBtn: $("channelBtn"), qualityBtn: $("qualityBtn"), qualityMenu: $("qualityMenu"),
        fsBtn: $("fsBtn"), channelOverlay: $("channelOverlay"), channelList: $("channelList"),
        toast: $("toast"), toastText: $("toastText"), toastLogo: $("toastLogo"),
        buffering: $("buffering"), error: $("error")
      };

      // === State ===
      let channels = [], currentIndex = 0, highlightIndex = 0, overlayOpen = false;
      let hideControlsTimeout, hls = null, levels = [], currentQuality = "auto";

      // === Utils ===
      const debounce = (fn, d) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };
      const clearHls = ()=>{ try { hls?.destroy(); hls=null; } catch{} };
      const isSafariNativeHLS = () => DOM.video.canPlayType('application/vnd.apple.mpegurl');
      const save = (k,v)=> localStorage.setItem(k,v);
      const load = (k)=> localStorage.getItem(k);

      // === Playlist load/parse ===
      async function loadM3U(){
        try {
          const res = await fetch(CONFIG.m3uUrl, { cache:"no-cache" });
          if(!res.ok) throw new Error(res.status);
          parseM3U(await res.text());
        } catch(err){ showError(`Playlist error: ${err.message}`); }
      }
      function parseM3U(txt){
        const lines = txt.split(/\r?\n/).map(l=>l.trim());
        let current={}; channels=[];
        for(const line of lines){
          if(!line) continue;
          if(line.startsWith("#EXTINF")){
            const name = line.match(/,(.*)$/)?.[1] || "Channel";
            const logo = line.match(/tvg-logo="([^"]*)"/i)?.[1] || null;
            current = { name, logo, url:null };
          } else if(!line.startsWith("#")){
            current.url = line;
            if(current.name && current.url) channels.push(current);
            current={};
          }
        }
        if(!channels.length){ showError("No valid channels found."); return; }
        renderChannelList();
        const lastIdx = Number(load("lastIndex"));
        playChannel(Number.isInteger(lastIdx) ? lastIdx : 0);
      }

      // === Channel list ===
      function renderChannelList(){
        const frag = document.createDocumentFragment();
        channels.forEach((ch, idx)=>{
          const li=document.createElement("li"); li.setAttribute("role","menuitem");
          if(ch.logo){ const img=document.createElement("img"); img.src=ch.logo; img.alt=`${ch.name} logo`; img.loading="lazy"; li.appendChild(img);}
          const span=document.createElement("span"); span.textContent=ch.name; li.appendChild(span);
          li.addEventListener("click", ()=>{ playChannel(idx); closeOverlay(); });
          frag.appendChild(li);
        });
        DOM.channelList.innerHTML=""; DOM.channelList.appendChild(frag);
        updateHighlight(); updateActiveChannel();
      }

      // === Playback ===
      async function playChannel(i){
        if(!channels.length) return;
        currentIndex = (i+channels.length)%channels.length; save("lastIndex",currentIndex);
        const ch=channels[currentIndex];
        try {
          DOM.buffering.classList.add("show"); DOM.error.classList.remove("show");
          clearHls(); levels=[]; buildQualityMenu();

          if (isSafariNativeHLS() && !Hls.isSupported()){
            DOM.video.src=ch.url; await DOM.video.play().catch(()=>{});
            showToast(ch); updateActiveChannel(); return;
          }
          hls=new Hls({ enableWorker:true, lowLatencyMode:true, liveDurationInfinity:true });

          hls.on(Hls.Events.ERROR,(_,d)=> d?.fatal && showError(`Stream error: ${d.details}`));
          hls.on(Hls.Events.MANIFEST_PARSED,()=>{
            levels=[...hls.levels]; buildQualityMenu(true); applySavedQualityPreference();
          });
          hls.on(Hls.Events.LEVEL_SWITCHED,(_,d)=> markQualityActive(hls.levels[d.level]?.height||"auto"));

          hls.loadSource(ch.url); hls.attachMedia(DOM.video);
          await DOM.video.play().catch(()=>{}); showToast(ch); updateActiveChannel();
        } catch(err){ showError(`Play error: ${err.message}`); }
        finally { DOM.buffering.classList.remove("show"); }
      }

      // === Quality ===
      function buildQualityMenu(hasLevels=false){
        DOM.qualityMenu.innerHTML="";
        const auto=makeQItem("Auto",()=>setQualityAuto()); if(currentQuality==="auto") auto.classList.add("active");
        DOM.qualityMenu.appendChild(auto); DOM.qualityMenu.appendChild(spacer());
        if(!hasLevels||!levels.length){ DOM.qualityMenu.appendChild(makeQItem("Only current","",true)); return; }
        levels.forEach(lv=>{
          const label=lv.height?`${lv.height}p`:"Level"; const hint=lv.bitrate?`${Math.round(lv.bitrate/1000)} kbps`:"";
          DOM.qualityMenu.appendChild(makeQItem(label,()=>setQualityHeight(lv.height||0),false,hint));
        });
        markQualityActive(currentQuality==="auto"?"auto":getCurrentHeight());
      }
      const makeQItem=(txt,fn,disabled=false,hint="")=>{
        const d=document.createElement("div"); d.className="q-item"; d.setAttribute("role","menuitem");
        d.innerHTML=`<span>${txt}</span>${hint?`<span class="q-hint">${hint}</span>`:""}`;
        if(!disabled) d.addEventListener("click",()=>{fn(); toggleQualityMenu(false);});
        else d.style.opacity=.6; return d;
      };
      const spacer=()=>{ const d=document.createElement("div"); d.style.height="6px"; return d; };
      const getCurrentHeight=()=> hls?.levels?.[hls.currentLevel]?.height||null;
      function markQualityActive(a){ [...DOM.qualityMenu.querySelectorAll(".q-item")].forEach(el=>el.classList.remove("active"));
        if(a==="auto") DOM.qualityMenu.firstChild?.classList.add("active");
        else [...DOM.qualityMenu.querySelectorAll(".q-item")].find(el=>el.textContent.trim().startsWith(`${a}p`))?.classList.add("active"); }
      function setQualityAuto(){ currentQuality="auto"; save("quality","auto"); if(hls){ hls.currentLevel=-1; hls.autoLevelEnabled=true; } markQualityActive("auto"); }
      function setQualityHeight(h){ currentQuality=h; save("quality",h); const c=hls.levels.map((lv,i)=>({i,h:lv.height,b:lv.bitrate})).filter(x=>x.h===h);
        if(!c.length)return; c.sort((a,b)=>b.b-a.b); hls.autoLevelEnabled=false; hls.currentLevel=c[0].i; markQualityActive(h); }
      function applySavedQualityPreference(){ const s=load("quality"); !s||s==="auto"?setQualityAuto():setQualityHeight(+s||0); }
      const toggleQualityMenu=(f)=>{ const show=typeof f==="boolean"?f:!DOM.qualityMenu.classList.contains("show"); DOM.qualityMenu.classList.toggle("show",show); DOM.qualityBtn.setAttribute("aria-expanded",show); };

      // === Overlay & Highlight ===
      const openOverlay=()=>{ overlayOpen=true; DOM.channelOverlay.classList.add("show"); highlightIndex=currentIndex; updateHighlight(); DOM.channelList.children[highlightIndex]?.scrollIntoView({block:"nearest"}); };
      const closeOverlay=()=>{ overlayOpen=false; DOM.channelOverlay.classList.remove("show"); };
      const toggleOverlay=()=> overlayOpen?closeOverlay():openOverlay();
      const updateHighlight=()=>[...DOM.channelList.children].forEach((li,i)=> li.classList.toggle("highlight",i===highlightIndex));
      const updateActiveChannel=()=>[...DOM.channelList.children].forEach((li,i)=> li.classList.toggle("active",i===currentIndex));

      // === Toast & Errors ===
      function showToast(ch){ DOM.toastText.textContent=ch.name; if(ch.logo){ DOM.toastLogo.src=ch.logo; DOM.toastLogo.style.display="block"; } else DOM.toastLogo.style.display="none";
        DOM.toast.classList.add("show"); setTimeout(()=>DOM.toast.classList.remove("show"),CONFIG.toastDuration); }
      function showError(msg){ DOM.error.textContent=msg; DOM.error.classList.add("show"); setTimeout(()=>DOM.error.classList.remove("show"),5000); }

      // === Controls visibility ===
      const showControls=debounce(()=>{ DOM.controls.classList.add("show"); clearTimeout(hideControlsTimeout);
        hideControlsTimeout=setTimeout(()=>DOM.controls.classList.remove("show"),CONFIG.controlsHideDelay); },CONFIG.debounceDelay);

      // === Keyboard & Touch ===
      function handleKeys(e){
        if(overlayOpen){
          if(e.key==="ArrowUp"){ highlightIndex=(highlightIndex-1+channels.length)%channels.length; updateHighlight(); DOM.channelList.children[highlightIndex]?.scrollIntoView({block:"nearest"}); }
          else if(e.key==="ArrowDown"){ highlightIndex=(highlightIndex+1)%channels.length; updateHighlight(); DOM.channelList.children[highlightIndex]?.scrollIntoView({block:"nearest"}); }
          else if(e.key==="Enter"){ playChannel(highlightIndex); closeOverlay(); }
          else if(e.key==="Escape"){ closeOverlay(); }
          e.preventDefault();
        } else {
          if(e.key==="ArrowLeft") playChannel(currentIndex-1);
          else if(e.key==="ArrowRight") playChannel(currentIndex+1);
          else if(e.key==="c") toggleOverlay();
        }
      }

      function setupEvents(){
        DOM.prevBtn.onclick=()=>playChannel(currentIndex-1);
        DOM.nextBtn.onclick=()=>playChannel(currentIndex+1);
        DOM.channelBtn.onclick=toggleOverlay;
        DOM.qualityBtn.onclick=(e)=>{e.stopPropagation(); toggleQualityMenu();};
        DOM.fsBtn.onclick=()=> document.fullscreenElement?document.exitFullscreen():DOM.player.requestFullscreen?.();
        document.addEventListener("click",(e)=>{ if(!DOM.qualityMenu.contains(e.target)&&e.target!==DOM.qualityBtn) toggleQualityMenu(false); });
        DOM.volume.oninput=()=>{ DOM.video.volume=+DOM.volume.value; save("volume",DOM.volume.value); };
        DOM.video.onwaiting=()=>DOM.buffering.classList.add("show"); DOM.video.onplaying=()=>DOM.buffering.classList.remove("show");
        
DOM.video.onerror=()=>showError("Error playing channel");

        ["mousemove","touchstart","keydown"].forEach(ev=>
          document.addEventListener(ev,showControls,{passive:true})
        );
        document.addEventListener("keydown",handleKeys);

        // Touch swipe for next/prev channel
        let sx=0,sy=0;
        DOM.player.addEventListener("touchstart",e=>{
          sx=e.touches[0].clientX; sy=e.touches[0].clientY;
        },{passive:true});
        DOM.player.addEventListener("touchend",e=>{
          const dx=e.changedTouches[0].clientX-sx, dy=e.changedTouches[0].clientY-sy;
          if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>50){
            dx>0? playChannel(currentIndex-1): playChannel(currentIndex+1);
          }
        },{passive:true});
      }

      // === Init ===
      window.addEventListener("load",()=>{
        setupEvents();
        loadM3U();
        const v=load("volume"); if(v) DOM.video.volume=DOM.volume.value=v;
        showControls(); // show initially
      });
    })();
  </script>
</body>
</html>