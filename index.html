<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>IPTV Pro</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{--bg:#000;--accent:#00ff9d;--text:#fff}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Segoe UI',Roboto,Arial,sans-serif;overflow:hidden}
video{width:100%;height:100%;position:fixed;top:0;left:0;background:#000;object-fit:contain;z-index:1}

.now-playing{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:transparent;padding:10px 20px;border-radius:50px;
  font-size:22px;font-weight:600;z-index:10;opacity:0;transition:.5s;
  white-space:nowrap;max-width:90%;overflow:hidden;text-overflow:ellipsis;
}
.now-playing.show{opacity:1}

.menu-btn{
  position:fixed;
  padding:5px 5px;background: transparent;color: white;
  border:2px solid var(--accent);border-radius:50px;font-size:18px;
  z-index:15;opacity:0;transition:.4s;cursor:pointer
}
.quality-btn,.fav-btn{
  /*position:fixed;*/
  padding:7px 7px;background:rgba(0,0,0,0.7);
  border:2px solid var(--accent);border-radius:50px;font-size:18px;
  z-index:15;opacity:0;transition:.4s;cursor:pointer
}
.menu-btn{top:5px;left:5px}
.fav-btn{bottom:15px;left:30px}
.quality-btn{bottom:15px;right:30px}
.menu-btn.show,.fav-btn.show,.quality-btn.show{opacity:1}

.favorites-panel{
  position:fixed;bottom:90px;left:30px;width:200px;max-height:60vh;
  background: transparent;backdrop-filter:blur(20px);
  border:2px solid var(--accent);border-radius:16px;overflow:hidden;
  z-index:20;opacity:0;transform:scale(0.9);transition:.3s;pointer-events:none;
  display:flex;flex-direction:column
}
.favorites-panel.show{opacity:1;transform:scale(1);pointer-events:all}
.fav-header{padding:7px 7px;background:var(--accent);color:#000;font-weight:bold;font-size:18px}
.fav-list{flex:1;overflow-y:auto;padding:8px}
.fav-item{padding:5px 5px;font-size:15px;cursor:pointer;transition:.2s;border-bottom:1px solid rgba(255,255,255,0.1)}
.fav-item:focus{background:var(--accent);color:#000;outline:none}
.fav-item:last-child{border-bottom:none}

.quality-menu{
  position:fixed;bottom:90px;right:30px;width:100px;
  background: transparent;backdrop-filter:blur(20px);
  border:2px solid var(--accent);border-radius:16px;padding:12px 0;
  z-index:20;opacity:0;transform:scale(.9);transition:.3s;pointer-events:none
}
.quality-menu.show{opacity:1;transform:scale(1);pointer-events:all}
.q-item{padding:5px 5px;font-size:18px;cursor:pointer;transition:.2s}
.q-item:focus{background:var(--accent);color:white}
.q-item.active{font-weight:bold}

.controls{
  position:fixed;bottom:5px;left:50%;transform:translateX(-50%);
  background:transparent;padding:10px 15px;border-radius:50px;
  display:flex;gap:20px;z-index:10;opacity:0;transition:.5s
}
.controls.show{opacity:1}
.btn{padding:10px 15px;background:rgba(255,255,255,0.15);border:none;border: 2px solid var(--accent);border-radius:50px;font-size:18px;color:#fff;cursor:pointer}

.sidebar{
  position:fixed;top:0;left:-400px;width:200px;height:100%;
  background: transparent;backdrop-filter:blur(20px);
  transition:left .4s cubic-bezier(.2,.8,.2,1);z-index:20;padding:20px;
  display:flex;flex-direction:column;gap:16px
}
.sidebar.visible{left:0}
.search{padding:10px;border-radius:16px;background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:18px;outline:none}
.channel-list{flex:1;overflow-y:auto}
.channel{
  padding:5px 5px;border-radius:14px;display:flex;align-items:center;justify-content:space-between;
  margin:4px 0;cursor:pointer;transition:.2s
}
.channel:focus{background:var(--accent);color:#000;transform:scale(1.02)}
.channel.active{background:var(--accent);color:#000;font-weight:bold}
.fav{font-size:24px;margin-left:10px;cursor:pointer}
</style>
</head>
<body>

<!-- FULL SCREEN BACKGROUND + BUFFERING OVERLAY -->
<div id="videoContainer" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;overflow:hidden">
  <video id="video" playsinline webkit-playsinline style="width:100%;height:100%;object-fit:contain"></video>
  
  <!-- BEAUTIFUL BUFFERING WITH DARK BG (NO BLACK FLASH!) -->
  <div id="buffering" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        z-index:3;display:flex;flex-direction:column;align-items:center;gap:20px;color:#00ff9d;
        font-size:24px;font-weight:bold;opacity:0;transition:opacity .3s">
    <svg width="90" height="90" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="40" stroke="#00ff9d" stroke-width="8" fill="none" opacity="0.3"/>
      <circle cx="50" cy="50" r="40" stroke="#00ff9d" stroke-width="9" fill="none" stroke-linecap="round"
        stroke-dasharray="90 150" transform="rotate(-90 50 50)">
        <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" 
          dur="1.4s" repeatCount="indefinite"/>
      </circle>
    </svg>
    <div></div>
  </div>
</div>


<div id="nowPlaying" class="now-playing">Loading...</div>
<button id="menuBtn" class="menu-btn">Menu</button>
<!--<button id="favBtn" class="fav-btn">üåü</button> -->
<!--<button id="qualityBtn" class="quality-btn">‚öôÔ∏è</button> -->

<div id="favoritesPanel" class="favorites-panel">
  <div class="fav-header">Favorite Channels</div>
  <div id="favList" class="fav-list"></div>
</div>

<div id="controls" class="controls">
  <button id="favBtn" class="fav-btn">üåü</button>
  <button class="btn" id="prev">‚èÆÔ∏è</button>
  <button class="btn" id="play"> ‚èØÔ∏è</button>
  <button class="btn" id="next"> ‚è≠Ô∏è </button>
  <button id="qualityBtn" class="quality-btn">‚öôÔ∏è</button>
</div>

<div id="qualityMenu" class="quality-menu"></div>

<aside id="sidebar" class="sidebar">
  <input type="text" id="search" class="search" placeholder="Search channels..." autocomplete="off">
  <div id="list" class="channel-list" tabindex="-1"></div>
</aside>

<script>
// ====================== STATE ======================
const video = document.getElementById('video');
const nowPlaying = document.getElementById('nowPlaying');
const menuBtn = document.getElementById('menuBtn');
const favBtn = document.getElementById('favBtn');
const qualityBtn = document.getElementById('qualityBtn');
const favoritesPanel = document.getElementById('favoritesPanel');
const favList = document.getElementById('favList');
const qualityMenu = document.getElementById('qualityMenu');
const controls = document.getElementById('controls');
const sidebar = document.getElementById('sidebar');
const list = document.getElementById('list');
const search = document.getElementById('search');

let channels = [], current = -1, hls = null;
let hideTimer = null;
let isSidebarOpen = false, isQualityOpen = false, isFavoritesOpen = false;
let backPressCount = 0;
let favorites = JSON.parse(localStorage.getItem('tv_favorites') || '[]');

// ====================== SAFE TEXT ======================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ====================== UI CONTROL ======================
function showUI() {
  nowPlaying.classList.add('show');
  menuBtn.classList.add('show');
  favBtn.classList.add('show');
  qualityBtn.classList.add('show');
  controls.classList.add('show');
  clearTimeout(hideTimer);
  hideTimer = setTimeout(hideUI, 4000);
}
function hideUI() {
  if (!isSidebarOpen && !isQualityOpen && !isFavoritesOpen) {
    nowPlaying.classList.remove('show');
    menuBtn.classList.remove('show');
    favBtn.classList.remove('show');
    qualityBtn.classList.remove('show');
    controls.classList.remove('show');
  }
}
document.addEventListener('mousemove', showUI);
document.addEventListener('keydown', showUI);

// ====================== LOAD PLAYLIST ======================
fetch('Playlist.m3u?t=' + Date.now())
  .then(r => r.ok ? r.text() : Promise.reject())
  .then(text => {
    const lines = text.split(/\r?\n/);
    channels = [];
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith('#EXTINF')) {
        const title = lines[i].split(',').slice(1).join(',').trim();
        const url = lines[i+1]?.trim();
        if (url && !url.startsWith('#')) channels.push({title, url});
        i++;
      }
    }
    renderChannels();
    renderFavoritesPanel();
    const last = localStorage.getItem('lastChannelTitle');
    const idx = last ? channels.findIndex(c => c.title === last) : 0;
    if (channels.length) playChannel(idx >= 0 ? idx : 0);
  })
  .catch(() => nowPlaying.textContent = "Playlist Failed");

// ====================== RENDER CHANNELS (FIXED!) ======================
function renderChannels() {
  list.innerHTML = '';
  const q = search.value.toLowerCase();
  channels.forEach((ch, idx) => {
    if (q && !ch.title.toLowerCase().includes(q)) return;

    const div = document.createElement('div');
    div.className = 'channel';
    div.tabIndex = 0;
    div.dataset.idx = idx;

    // SAFE WAY ‚Äì no template literals in innerHTML!
    const titleSpan = document.createElement('span');
    titleSpan.className = 'channel-title';
    titleSpan.textContent = ch.title;

    const starSpan = document.createElement('span');
    starSpan.className = 'fav';
    starSpan.textContent = favorites.includes(idx) ? '‚òÖ' : '‚òÜ';
    starSpan.style.cursor = 'pointer';

    div.appendChild(titleSpan);
    div.appendChild(starSpan);
    list.appendChild(div);

    div.onclick = () => { playChannel(idx); hideSidebar(); };
    div.onkeydown = e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); playChannel(idx); hideSidebar(); }
      if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFavorite(idx); }
    };
    starSpan.onclick = ev => { ev.stopPropagation(); toggleFavorite(idx); };

    if (idx === current) div.classList.add('active');
  });
  if (isSidebarOpen) setTimeout(() => list.firstElementChild?.focus(), 100);
}

// ====================== FAVORITES PANEL ======================
function renderFavoritesPanel() {
  favList.innerHTML = '';
  const favChannels = favorites.map(i => channels[i]).filter(Boolean);
  if (!favChannels.length) {
    favList.innerHTML = '<div style="padding:10px;color:#888;text-align:center">No favorites yet</div>';
    return;
  }
  favChannels.forEach(ch => {
    const idx = channels.indexOf(ch);
    const div = document.createElement('div');
    div.className = 'fav-item';
    div.tabIndex = 0;
    div.textContent = ch.title;
    div.onclick = () => { playChannel(idx); hideFavoritesPanel(); };
    div.onkeydown = e => { if (e.key === 'Enter') div.click(); };
    favList.appendChild(div);
  });
}
function showFavoritesPanel() { isFavoritesOpen = true; favoritesPanel.classList.add('show'); renderFavoritesPanel(); setTimeout(() => favList.firstElementChild?.focus(), 100); showUI(); }
function hideFavoritesPanel() { isFavoritesOpen = false; favoritesPanel.classList.remove('show'); hideUI(); }

// ====================== FAVORITES SYSTEM ======================
function toggleFavorite(idx) {
  if (favorites.includes(idx)) favorites = favorites.filter(x => x !== idx);
  else favorites.push(idx);
  localStorage.setItem('tv_favorites', JSON.stringify(favorites));
  renderChannels();
  renderFavoritesPanel();
}

// ====================== PLAY CHANNEL ======================
/*
function playChannel(idx) {
  if (idx < 0 || idx >= channels.length || idx === current) {
    video.paused ? video.play() : video.pause();
    return;
  }
  current = idx;
  const ch = channels[current];
  nowPlaying.textContent = ch.title;
  localStorage.setItem('lastChannelTitle', ch.title);
  showUI();

  document.querySelectorAll('.channel').forEach(el => el.classList.toggle('active', Number(el.dataset.idx) === current));

  if (hls) hls.destroy();
  qualityMenu.innerHTML = '';

  if (Hls.isSupported() && /\.m3u8/i.test(ch.url)) {
    hls = new Hls();
    hls.loadSource(ch.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play(); buildQualityMenu(); });
  } else {
    video.src = ch.url;
    video.play();
  }
}
*/
/*
// ====================== PLAY CHANNEL ‚Äì FIXED WITH FULL CLEANUP ======================
function playChannel(idx) {
  if (idx < 0 || idx >= channels.length) return;

  // If same channel ‚Üí just play/pause
  if (idx === current) {
    video.paused ? video.play() : video.pause();
    return;
  }

  // INSTANT BUFFERING + CLEAN OLD STREAM
  showBuffering();

  current = idx;
  const ch = channels[current];
  nowPlaying.textContent = ch.title;
  localStorage.setItem('lastChannelTitle', ch.title);
  showUI();

  // FULL CLEANUP OF OLD STREAM
  if (hls) {
    hls.destroy();           // ‚Üê This was missing proper cleanup!
    hls = null;
  }
  if (video.src && video.src.startsWith('blob:')) {
    URL.revokeObjectURL(video.src);
  }
  video.src = '';            // ‚Üê Force clear old source
  video.removeAttribute('src');
  video.load();              // ‚Üê Critical: forces browser to drop old stream

  document.querySelectorAll('.channel').forEach(el => 
    el.classList.toggle('active', Number(el.dataset.idx) === current)
  );

  qualityMenu.innerHTML = '';  // Clear old quality menu

  // PLAY NEW CHANNEL
  setTimeout(() => {  // Small delay to ensure cleanup
    if (Hls.isSupported() && /\.m3u8/i.test(ch.url)) {
      hls = new Hls({
        maxBufferLength: 10,
        maxMaxBufferLength: 20,
        liveSyncDurationCount: 3,
        enableWorker: true
      });
      hls.loadSource(ch.url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play();
        buildQualityMenu();
      });
      hls.on(Hls.Events.ERROR, (event, data) => {
        if (data.fatal) {
          hideBuffering();
          nowPlaying.textContent = "Stream Error";
        }
      });
    } else {
      video.src = ch.url;
      video.play();
    }
  }, 100);
}
*/
/*
// ====================== FINAL PERFECT playChannel ‚Äì ULTRA FAST + 100% COMPATIBLE ======================
function playChannel(idx) {
  if (idx < 0 || idx >= channels.length) return;

  // Same channel ‚Üí just toggle play/pause
  if (idx === current) {
    video.paused ? video.play() : video.pause();
    return;
  }

  // INSTANT BUFFERING + FULL CLEANUP
  showBuffering();

  current = idx;
  const ch = channels[current];
  nowPlaying.textContent = ch.title;
  localStorage.setItem('lastChannelTitle', ch.title);
  showUI();

  // FULL DESTROY OLD HLS + MEDIA SOURCE
  if (hls) {
    hls.destroy();
    hls = null;
  }
  if (video.src) {
    if (video.src.startsWith('blob:')) URL.revokeObjectURL(video.src);
    video.src = '';
    video.removeAttribute('src');
    video.load();
  }

  // Update active channel highlight
  document.querySelectorAll('.channel').forEach(el =>
    el.classList.toggle('active', Number(el.dataset.idx) === current)
  );
  qualityMenu.innerHTML = '';  // Clear quality menu

  // PLAY NEW CHANNEL AFTER CLEANUP
  setTimeout(() => {
    const url = ch.url.trim();

    // 1. HLS (.m3u8) ‚Äì Best quality & support
    if (Hls.isSupported() && url.includes('.m3u8')) {
      hls = new Hls({
        maxBufferLength: 10,
        maxMaxBufferLength: 20,
        liveSyncDurationCount: 3,
        enableWorker: true
      });
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play();
        buildQualityMenu();
        hideBuffering();
      });
      hls.on(Hls.Events.ERROR, (e, data) => {
        if (data.fatal) {
          hideBuffering();
          nowPlaying.textContent = "HLS Error";
        }
      });
    }

    // 2. RAW MPEG-TS (like http://87.255.35.150:18890/...) ‚Äì Now plays perfectly!
    else if (url.includes('.ts') || 
             url.match(/:\d{4,6}\/(?:\d+|live|movie|series|$)/) || 
             !url.includes('.') || 
             url.includes(':18890') || 
             url.includes(':25461')) {
      
      if ('MediaSource' in window) {
        const mse = new MediaSource();
        video.src = URL.createObjectURL(mse);
        mse.addEventListener('sourceopen', () => {
          const sb = mse.addSourceBuffer('video/mp2t');
          const loadChunk = () => {
            fetch(url, { credentials: 'omit' })
              .then(r => r.arrayBuffer())
              .then(buf => {
                if (mse.readyState === 'open' && !sb.updating) {
                  sb.appendBuffer(buf);
                }
              })
              .catch(() => {}); // Silent retry
          };
          sb.addEventListener('updateend', loadChunk);
          loadChunk();
        });
        video.play();
        video.addEventListener('playing', hideBuffering, { once: true });
      } else {
        video.src = url;
        video.play();
      }
    }

    // 3. DIRECT MP4 / OTHER STREAMS
    else {
      video.src = url;
      video.play();
      video.addEventListener('playing', hideBuffering, { once: true });
    }

    // Fallback: Hide buffering if still not playing after 8 sec
    setTimeout(() => {
      if (video.paused && buffering.style.opacity === '1') {
        hideBuffering();
        nowPlaying.textContent = "No Signal";
      }
    }, 8000);

  }, 120);
}*/
// ====================== 100% WORKING playChannel ‚Äì NO MORE ERRORS ======================
function playChannel(idx) {
  if (idx < 0 || idx >= channels.length) return;

  // Toggle play/pause on same channel
  if (idx === current) {
    video.paused ? video.play() : video.pause();
    return;
  }

  showBuffering();                                      // instant loading spinner
  current = idx;
  const ch = channels[current];
  nowPlaying.textContent = ch.title;
  localStorage.setItem('lastChannelTitle', ch.title);
  showUI();

  // FULL CLEANUP ‚Äì prevents all old-stream errors
  if (hls) { hls.destroy(); hls = null; }
  if (video.src) {
    if (video.src.startsWith('blob:')) URL.revokeObjectURL(video.src);
    video.src = '';
    video.removeAttribute('src');
    video.load();
  }
  qualityMenu.innerHTML = '';

  document.querySelectorAll('.channel').forEach(el =>
    el.classList.toggle('active', Number(el.dataset.idx) === current)
  );

  // === PLAY NEW STREAM AFTER CLEANUP ===
  setTimeout(() => {
    const url = ch.url.trim();

    // 1. HLS (.m3u8) ‚Äì most reliable way
    if (Hls.isSupported() && url.includes('.m3u8')) {
      hls = new Hls({
        maxBufferLength: 15,
        maxMaxBufferLength: 30,
        liveSyncDurationCount: 3,
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 10
      });

      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play().catch(() => {});
        buildQualityMenu();
      });

      hls.on(Hls.Events.ERROR, (event, data) => {
        if (data.fatal) {
          console.warn('HLS fatal ‚Üí fallback to direct');
          fallbackDirect(url);
        }
      });

      hls.loadSource(url);
      hls.attachMedia(video);
      return;
    }

    // 2. RAW TS / DIRECT STREAMS (87.255.x.x, port 18890, 25461, etc.)
    fallbackDirect(url);
  }, 120);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fallback function used by both HLS & direct streams ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fallbackDirect(url) {
  // Try MediaSource first (best for raw .ts streams)
  if ('MediaSource' in window && (url.includes('.ts') || /:\d{4,6}[/?]/.test(url))) {
    const mse = new MediaSource();
    video.src = URL.createObjectURL(mse);

    mse.addEventListener('sourceopen', () => {
      const sb = mse.addSourceBuffer('video/mp2t');   // MPEG-TS codec

      const appendNext = () => {
        fetch(url, { credentials: 'omit', cache: 'no-store' })
        .then(r => r.arrayBuffer())
        .then(buf => {
          if (mse.readyState === 'open' && !sb.updating) {
            try { sb.appendBuffer(buf); } catch(e) {}
          }
        })
        .catch(() => {}); // silent retry
      };

      sb.addEventListener('updateend', appendNext);
      appendNext();
    });

    video.play().catch(() => {});
    video.addEventListener('playing', hideBuffering, { once: true });
  } 
  // Normal direct playback (MP4, FLV, or any direct link)
  else {
    video.src = url;
    video.play().catch(() => {
      // Last resort: try with a proxy if CORS blocks it
      video.src = 'https://corsproxy.io/?' + encodeURIComponent(url);
      video.play().catch(() => {});
    });
    video.addEventListener('playing', hideBuffering, { once: true });
  }

  // Auto-hide spinner after max 12 seconds (prevents stuck loading)
  setTimeout(hideBuffering, 12000);
}
// ====================== QUALITY MENU ======================
function buildQualityMenu() {
  qualityMenu.innerHTML = '';
  if (!hls?.levels) return;
  const levels = [{name: 'Auto', level: -1}, ...hls.levels.map((l,i) => ({name: l.height + 'p', level: i}))];
  levels.forEach(lv => {
    const item = document.createElement('div');
    item.className = 'q-item';
    item.tabIndex = 0;
    item.textContent = lv.name;
    if (hls.currentLevel === lv.level) item.classList.add('active');
    item.onclick = () => { hls.currentLevel = lv.level; qualityMenu.querySelectorAll('.q-item').forEach(x => x.classList.remove('active')); item.classList.add('active'); hideQualityMenu(); };
    qualityMenu.appendChild(item);
  });
}
function showQualityMenu() { if (!hls) return; isQualityOpen = true; qualityMenu.classList.add('show'); buildQualityMenu(); setTimeout(() => qualityMenu.firstChild?.focus(), 100); showUI(); }
function hideQualityMenu() { isQualityOpen = false; qualityMenu.classList.remove('show'); hideUI(); }

// ====================== SIDEBAR ======================
function showSidebar() { sidebar.classList.add('visible'); isSidebarOpen = true; setTimeout(() => list.firstElementChild?.focus(), 100); showUI(); }
function hideSidebar() { sidebar.classList.remove('visible'); isSidebarOpen = false; hideUI(); }

// ====================== KEY HANDLER + CLICK OUTSIDE TO CLOSE ======================
document.addEventListener('keydown', e => {
  showUI();

  // BACK / ESCAPE ‚Üí Close any open panel instantly
  if (e.key === 'Backspace' || e.key === 'Escape') {
    e.preventDefault();

    if (isFavoritesOpen) { hideFavoritesPanel(); return; }
    if (isQualityOpen)   { hideQualityMenu();   return; }
    if (isSidebarOpen)   { hideSidebar();       return; }

    // Double back to exit app
    if (backPressCount++ === 0) {
      nowPlaying.textContent = "Press back again to exit";
      nowPlaying.classList.add('show');
      setTimeout(() => { backPressCount = 0; hideUI(); }, 2000);
    } else {
      if (window.Android?.exitApp) window.Android.exitApp();
      else window.close();
    }
    return;
  }

  // Rest of your keys (m, space, arrows, etc.)
  if (e.key.toLowerCase() === 'm') { e.preventDefault(); isSidebarOpen ? hideSidebar() : showSidebar(); return; }
  if (e.key === ' ') { e.preventDefault(); video.paused ? video.play() : video.pause(); return; }

  if (isFavoritesOpen || isQualityOpen || isSidebarOpen) {
    const focused = document.activeElement;
    if (e.key === 'ArrowUp')   { e.preventDefault(); (focused.previousElementSibling || focused.parentNode.lastElementChild)?.focus(); }
    if (e.key === 'ArrowDown') { e.preventDefault(); (focused.nextElementSibling || focused.parentNode.firstElementChild)?.focus(); }
    if (e.key === 'Enter')     focused?.click();
  }
});

// CLICK OUTSIDE ANY PANEL ‚Üí CLOSE IT
document.addEventListener('click', e => {
  if (isSidebarOpen && !sidebar.contains(e.target) && e.target !== menuBtn) {
    hideSidebar();
  }
  if (isFavoritesOpen && !favoritesPanel.contains(e.target) && e.target !== favBtn) {
    hideFavoritesPanel();
  }
  if (isQualityOpen && !qualityMenu.contains(e.target) && e.target !== qualityBtn) {
    hideQualityMenu();
  }
});

// ====================== BUTTONS ======================
menuBtn.onclick = () => isSidebarOpen ? hideSidebar() : showSidebar();
favBtn.onclick = () => isFavoritesOpen ? hideFavoritesPanel() : showFavoritesPanel();
qualityBtn.onclick = () => isQualityOpen ? hideQualityMenu() : showQualityMenu();
document.getElementById('prev').onclick = () => playChannel((current - 1 + channels.length) % channels.length);
document.getElementById('next').onclick = () => playChannel((current + 1) % channels.length);
document.getElementById('play').onclick = () => video.paused ? video.play() : video.pause();

search.oninput = () => renderChannels();
window.addEventListener('contextmenu', e => e.preventDefault());

const buffering = document.getElementById('buffering');

// Show buffering immediately when source changes
function showBuffering() {
  buffering.style.opacity = '1';
  buffering.style.display = 'flex';
}

function hideBuffering() {
  buffering.style.opacity = '0';
  setTimeout(() => { buffering.style.display = 'none'; }, 300);
}

// Show buffering when changing channel
const originalPlayChannel = playChannel;
playChannel = function(idx) {
  showBuffering();  // ‚Üê INSTANT show (no black flash!)
  originalPlayChannel(idx);
};

// Hide when video actually starts playing
video.addEventListener('playing', hideBuffering);
video.addEventListener('canplay', hideBuffering);
video.addEventListener('error', () => {
  hideBuffering();
  nowPlaying.textContent = "Stream Failed";
});

// ====================== PLAY RAW MPEG-TS STREAMS (FIX FOR 87.255.35.150 TYPE URLs) ======================
function playRawTS(url) {
  // Use native support with fetch + MediaSource (works in 99% devices)
  if ('MediaSource' in window) {
    const mse = new MediaSource();
    video.src = URL.createObjectURL(mse);

    mse.addEventListener('sourceopen', () => {
      const sourceBuffer = mse.addSourceBuffer('video/mp2t; codecs="avc1.42E01E, mp4a.40.2"');
      
      function loadSegment() {
        fetch(url, { method: 'GET', credentials: 'omit' })
          .then(r => r.arrayBuffer())
          .then(data => {
            if (mse.readyState === 'open') {
              sourceBuffer.appendBuffer(data);
            }
          })
          .catch(() => { /* ignore small errors ‚Äì stream keeps trying */ });
      }

      sourceBuffer.addEventListener('updateend', loadSegment);
      loadSegment(); // start first chunk
    });
  } else {
    // Fallback ‚Äì try direct (rarely works, but safe)
    video.src = url;
    video.play();
  }
}
</script>
</body>
</html>
