<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Perfect TV Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  :root{--bg:#000;--accent:#00ff9d;--text:#fff;--muted:#aaa}
  *{margin:0;padding:0;box-sizing:border-box}
  body,html{height:100%;background:var(--bg);color:var(--text);font-family:Roboto,Arial,sans-serif;overflow:hidden}
  video{width:100%;height:100%;object-fit:contain;background:#000}

  /* Hidden by default - pure cinema mode */
  .ui-layer{position:absolute;inset:0;pointer-events:none;z-index:10}
  .menu-btn{position:absolute;top:20px;left:20px;padding:12px 18px;background:rgba(0,0,0,0.6);border:2px solid var(--accent);border-radius:50px;font-size:18px;opacity:0;transition:all .4s;pointer-events:all;cursor:pointer}
  .menu-btn.show{opacity:1;transform:scale(1)} 
  .menu-btn.hide{opacity:0;transform:scale(0.8)}

  /* Sidebar - slides in */
  .sidebar{position:absolute;top:0;left:-450px;width:420px;height:100%;background:rgba(10,10,20,0.98);backdrop-filter:blur(20px);transition:left .4s ease;z-index:20;padding:20px;display:flex;flex-direction:column;gap:16px}
  .sidebar.visible{left:0}

  .search{padding:14px;border-radius:12px;border:none;background:rgba(255,255,255,0.1);color:white;font-size:16px}
  .channel-list{flex:1;overflow-y:auto}
  .channel{padding:14px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:.2s;cursor:pointer}
  .channel:focus,.channel:hover{background:rgba(0,255,157,0.15)}
  .channel.active{background:var(--accent);color:#000;font-weight:bold}
  .channel-title{flex:1;font-size:17px}
  .fav-btn{font-size:20px;opacity:0.6}
  .fav-btn.active{opacity:1;color:#ff9800}

  /* Bottom info - current channel */
  .now-playing{position:absolute;bottom:30px;left:30px;background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:50px;font-size:18px;opacity:0;transition:opacity .5s}

  /* Controls bar - appears only on navigation */
  .controls-bar{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,#111);padding:30px 40px;display:flex;align-items:center;gap:20px;opacity:0;transition:opacity .4s;pointer-events:none}
  .controls-bar.show{opacity:1;pointer-events:all}
  .ctrl-btn{padding:14px 24px;background:rgba(255,255,255,0.15);border-radius:50px;font-size:20px;border:none;color:white;cursor:pointer}

  .quality-list{position:absolute;bottom:100px;right:40px;display:flex;gap:10px;flex-wrap:wrap;opacity:0;transition:opacity .4s}
  .quality-list.show{opacity:1}
  .qbtn{padding:8px 14px;background:rgba(255,255,255,0.2);border-radius:8px;font-size:14px}
  .qbtn.active{background:var(--accent);color:#000}
</style>
</head>
<body>

<video id="video" playsinline webkit-playsinline></video>

<div class="ui-layer">
  <button id="menuBtn" class="menu-btn">Menu</button>
  <div id="nowPlaying" class="now-playing">Loading...</div>

  <div class="controls-bar" id="controls">
    <button class="ctrl-btn" id="prevBtn">Previous</button>
    <button class="ctrl-btn" id="playBtn">Play</button>
    <button class="ctrl-btn" id="nextBtn">Next</button>
    <div style="flex:1"></div>
    <div id="qualityList" class="quality-list"></div>
  </div>
</div>

<!-- Sliding Sidebar -->
<aside class="sidebar" id="sidebar">
  <input type="text" id="search" class="search" placeholder="Search channels..." autocomplete="off">
  <div id="channelList" class="channel-list"></div>
  <div style="text-align:center;color:#666;font-size:14px">
    Favorites: Long-press OK • DPAD: Navigate • Back: Hide
  </div>
</aside>

<script>
// ============== STATE ==============
const video = document.getElementById('video');
const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');
const channelList = document.getElementById('channelList');
const nowPlaying = document.getElementById('nowPlaying');
const controls = document.getElementById('controls');
const qualityList = document.getElementById('qualityList');
const searchInput = document.getElementById('search');

let channels = [], filtered = [], current = -1;
let hls = null, preHls = null;
let hideTimer = null;
let isSidebarVisible = false;
let favorites = JSON.parse(localStorage.getItem('tv_favs') || '[]');

// ============== LOAD PLAYLIST ==============
fetch('https://raw.githubusercontent.com/rsingh-fbd/R.singh/main/Playlist.m3u?t=' + Date.now())
  .then(r => r.text())
  .then(text => {
    const lines = text.split(/\r?\n/);
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith('#EXTINF')) {
        const title = lines[i].split(',').slice(1).join(',').trim();
        const url = lines[i+1]?.trim();
        if (url && !url.startsWith('#')) channels.push({title, url, fav: favorites.includes(title)});
      }
    }
    filtered = channels.slice();
    renderChannels();
    playChannel(0);
  });

// ============== RENDER CHANNELS ==============
function renderChannels() {
  channelList.innerHTML = '';
  filtered.forEach((ch, i) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.tabIndex = 0;
    div.innerHTML = `
      <span class="channel-title">${ch.title}</span>
      <span class="fav-btn ${ch.fav?'active':''}">Star</span>
    `;
    div.onclick = () => playChannel(i);
    div.onkeydown = e => {
      if (e.key === 'Enter') playChannel(i);
      if (e.key === 'OK' || e.key === ' ') { e.preventDefault(); toggleFav(ch.title, div); }
    };
    div.onfocus = () => div.style.background = 'rgba(0,255,157,0.2)';
    div.onblur = () => div.style.background = '';
    if (i === current) div.classList.add('active');
    channelList.appendChild(div);
  });
}

function toggleFav(title, el) {
  const idx = favorites.indexOf(title);
  if (idx === -1) favorites.push(title);
  else favorites.splice(idx, 1);
  localStorage.setItem('tv_favs', JSON.stringify(favorites));
  el.querySelector('.fav-btn').classList.toggle('active');
}

// ============== PLAY CHANNEL ==============
async function playChannel(idx) {
  if (idx < 0 || idx >= filtered.length) return;
  current = idx;
  const ch = filtered[idx];
  nowPlaying.textContent = ch.title;
  showNowPlaying();

  // Update active state
  [...channelList.children].forEach((el,i) => el.classList.toggle('active', i===idx));

  // Cleanup old
  if (hls) hls.destroy();
  if (preHls) preHls.destroy();

  if (Hls.isSupported() && ch.url.includes('.m3u8')) {
    hls = new Hls({enableWorker: true});
    hls.loadSource(ch.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
      setupQuality();
    });
  } else {
    video.src = ch.url;
    video.play();
  }

  hideUIAfterDelay();
}

// ============== QUALITY ==============
function setupQuality() {
  qualityList.innerHTML = '<div class="qbtn active">Auto</div>';
  hls.levels.forEach((l,i) => {
    const btn = document.createElement('div');
    btn.className = 'qbtn';
    btn.textContent = l.height + 'p';
    btn.onclick = () => {
      hls.currentLevel = i;
      [...qualityList.children].forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
    qualityList.appendChild(btn);
  });
  qualityList.children[0].onclick = () => {
    hls.currentLevel = -1;
    [...qualityList.children].forEach((b,i) => b.classList.toggle('active', i===0));
  };
}

// ============== UI CONTROL ==============
function showMenuButton() {
  menuBtn.classList.add('show');
  menuBtn.classList.remove('hide');
}
function hideMenuButton() {
  menuBtn.classList.remove('show');
  menuBtn.classList.add('hide');
}
function showNowPlaying() {
  nowPlaying.style.opacity = '1';
}
function hideUIAfterDelay() {
  clearTimeout(hideTimer);
  hideTimer = setTimeout(() => {
    if (!isSidebarVisible) {
      hideMenuButton();
      nowPlaying.style.opacity = '0';
      controls.classList.remove('show');
      qualityList.classList.remove('show');
    }
  }, 5000);
}

// Show UI on any key
document.addEventListener('keydown', e => {
  showMenuButton();
  showNowPlaying();
  controls.classList.add('show');
  qualityList.classList.add('show');
  hideUIAfterDelay();

  if (e.key === 'Backspace' || e.key === 'Escape') {
    if (isSidebarVisible) { hideSidebar(); e.preventDefault(); }
  }
});

// Menu button
menuBtn.onclick = () => {
  if (isSidebarVisible) hideSidebar();
  else showSidebar();
};

function showSidebar() {
  sidebar.classList.add('visible');
  isSidebarVisible = true;
  setTimeout(() => searchInput.focus(), 400);
}
function hideSidebar() {
  sidebar.classList.remove('visible');
  isSidebarVisible = false;
  hideUIAfterDelay();
}

// Navigation
document.getElementById('prevBtn').onclick = () => playChannel((current - 1 + filtered.length) % filtered.length);
document.getElementById('nextBtn').onclick = () => playChannel((current + 1) % filtered.length);
document.getElementById('playBtn').onclick = () => video.paused ? video.play() : video.pause();

// Search
searchInput.addEventListener('input', () => {
  const q = searchInput.value.toLowerCase();
  filtered = channels.filter(c => c.title.toLowerCase().includes(q));
  renderChannels();
});

// Start hidden
hideMenuButton();
nowPlaying.style.opacity = '0';

// Prevent context menu
window.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>