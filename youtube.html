<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hindi Movies Playlist</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #fff; }
    .container { display: flex; flex-direction: column; gap: 20px; max-width: 1200px; margin: auto; }
    #player-container {
      position: relative; width: 100%; padding-top: 56.25%; background: #000; border-radius: 8px; overflow: hidden;
    }
    #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #fallback-message {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.8); color: white; font-size: 20px; text-align: center; padding: 20px;
    }
    #playlist { background: #1e1e1e; border-radius: 8px; padding: 15px; }
    .video-item {
      display: flex; align-items: center; padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 6px;
      transition: background 0.2s;
    }
    .video-item:focus { background: #3367d6; outline: none; } /* DPAD focus highlight */
    .video-item:hover { background: #2d2d2d; }
    .video-item.active { background: #3367d6; font-weight: bold; }
    .video-item img { width: 120px; height: 90px; object-fit: cover; margin-right: 15px; border-radius: 4px; }
    .video-title { flex: 1; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Hindi Movies Playlist</h1>
  <div class="container">
    <div id="player-container">
      <div id="player"></div>
      <div id="fallback-message" style="display:none;">
        <p>Embedding blocked by channel</p>
        <p id="opening-text">Opening in YouTube...</p>
        <p style="font-size:14px; margin-top:20px;">Press OK or wait 3 seconds</p>
      </div>
    </div>

    <div id="playlist">
      <h2>Playlist</h2>
      <div id="video-list">Loading videos...</div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    let player;
    let videos = [];
    let currentIndex = 0;
    let fallbackTimeout;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: {
          autoplay: 1,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          iv_load_policy: 3,
          fs: 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });
    }

    function onPlayerReady() {
      loadPlaylist();
    }

    function onPlayerStateChange(event) {
      // Optional: auto next when ends (only if embed works)
      if (event.data === YT.PlayerState.ENDED && currentIndex < videos.length - 1) {
        currentIndex++;
        tryPlayOrFallback(currentIndex);
      }
    }

    function onPlayerError(event) {
      // Common error 150/151 = embedding disabled by owner
      if (event.data === 150 || event.data === 151 || event.data === 100) {
        triggerFallback(currentIndex);
      }
    }

    async function loadPlaylist() {
      try {
        const response = await fetch('files/videos.json');
        videos = await response.json();

        const list = document.getElementById('video-list');
        list.innerHTML = '';

        videos.forEach((video, index) => {
          const videoId = extractVideoId(video.url);
          const thumb = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;

          const item = document.createElement('div');
          item.className = 'video-item';
          item.tabIndex = 0; // Make focusable for DPAD
          item.innerHTML = `
            <img src="\( {thumb}" alt=" \){video.title}">
            <div class="video-title">${video.title}</div>
          `;
          item.onclick = () => tryPlayOrFallback(index);
          item.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              tryPlayOrFallback(index);
            }
          };
          list.appendChild(item);
        });

        if (videos.length > 0) {
          tryPlayOrFallback(0);
          document.querySelector('.video-item').focus(); // Initial focus
        }
      } catch (err) {
        document.getElementById('video-list').innerHTML = '<p>Error loading videos.json</p>';
        console.error(err);
      }
    }

    function extractVideoId(urlOrId) {
      if (urlOrId.length === 11) return urlOrId;
      const match = urlOrId.match(/(?:v=|\/embed\/|\/\d{4}\/\d{2}\/\d{2}\/|\/vi\/|youtu\.be\/|watch\?v=)([^#\&\?]{11})/);
      return match ? match[1] : urlOrId;
    }

    function tryPlayOrFallback(index) {
      currentIndex = index;
      const videoId = extractVideoId(videos[index].url);

      // Reset player and try embed
      document.getElementById('fallback-message').style.display = 'none';
      player.loadVideoById(videoId);

      // Highlight current item
      document.querySelectorAll('.video-item').forEach((el, i) => {
        el.classList.toggle('active', i === index);
      });

      // If embed fails, onError will trigger fallback
    }

    function triggerFallback(index) {
      document.getElementById('fallback-message').style.display = 'flex';
      document.getElementById('opening-text').textContent = `Opening "${videos[index].title}" in YouTube...`;

      // Auto open after 3 seconds (or on OK press)
      clearTimeout(fallbackTimeout);
      fallbackTimeout = setTimeout(() => {
        window.open(videos[index].url, '_blank');
      }, 3000);

      // Allow manual trigger with Enter/OK
      document.getElementById('player-container').focus();
    }

    // DPAD Navigation Support
    document.addEventListener('keydown', (e) => {
      const items = document.querySelectorAll('.video-item');
      const current = document.activeElement;
      let index = Array.from(items).indexOf(current);

      if (items.length === 0) return;

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          index = (index + 1) % items.length;
          items[index].focus();
          break;
        case 'ArrowUp':
          e.preventDefault();
          index = (index - 1 + items.length) % items.length;
          items[index].focus();
          break;
        case 'Enter':
        case ' ':
          if (current.classList.contains('video-item')) {
            e.preventDefault();
            tryPlayOrFallback(Array.from(items).indexOf(current));
          } else if (document.getElementById('fallback-message').style.display === 'flex') {
            clearTimeout(fallbackTimeout);
            window.open(videos[currentIndex].url, '_blank');
          }
          break;
      }
    });
  </script>
</body>
</html>